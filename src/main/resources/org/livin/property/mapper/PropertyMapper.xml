<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.livin.property.mapper.PropertyMapper">

    <!--    <select id="selectPropertyNearLocationByUserId" resultMap="SelectPropertyNearLocationMap">-->
    <!--        SELECT property_id, name-->
    <!--        FROM Property-->
    <!--        WHERE sido = #{sido}-->
    <!--          AND sigungu = #{sigungu}-->
    <!--          AND eupmyendong = #{eupmyendong} LIMIT #{limit}-->
    <!--    </select>-->


    <select id="selectPropertyListByRegion" resultMap="SelectPropertyNearLocationMap">
        SELECT
        p.property_id,
        p.name AS property_name,
        p.detail_address,
        p.property_type,
        p.transaction_type,
        p.jeonse_deposit,
        p.monthly_deposit,
        p.monthly_rent,
        p.transaction_type,
        p.main_direction,
        p.supply_area_m2,
        p.exclusive_area_m2,
        p.created_at AS property_created_at,

        -- riskAnalysis 정보
        r.is_safe,

        -- Building 정보
        b.total_floors,
        b.road_address,

        CASE WHEN f.user_id IS NOT NULL THEN true ELSE false END AS is_favorite

        FROM Property p
        LEFT JOIN riskAnalysis r ON p.property_id = r.property_id
        LEFT JOIN Building b ON p.building_id = b.building_id
        LEFT JOIN FavoriteProperty f ON p.property_id = f.property_id AND f.user_id = #{userId}

        <where>
            <if test="sido != null and sido != '전체'">
                AND sido = #{sido}
            </if>
            <if test="sigungu != null and sigungu != '전체'">
                AND sigungu = #{sigungu}
            </if>
            <if test="eupmyendong != null and eupmyendong != '전체'">
                AND eupmyendong = #{eupmyendong}
            </if>
            <if test="property_type != null and property_type != '전체'">
                AND property_type = #{property_type}
            </if>
            <if test="property_type != null and property_type != '전체'">
                AND property_type = #{property_type}
            </if>
            <if test="property_type != null and property_type != '전체'">
                AND property_type = #{property_type}
            </if>
        </where>

        ORDER BY property_created_at DESC
        LIMIT #{lastId}, #{limit}
    </select>


    <resultMap id="SelectPropertyNearLocationMap" type="PropertyVO">
        <result column="property_id" property="propertyId"/>
        <result column="name" property="name"/>
    </resultMap>

</mapper>