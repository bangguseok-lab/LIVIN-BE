<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.livin.property.mapper.PropertyChecklistMapper">

    <select id="selectChecklistTitlesByUserId"
            parameterType="long"
            resultType="org.livin.property.dto.ChecklistTitleDTO">
        SELECT
            checklist_id AS checklistId,
            title
        FROM Checklist
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <select id="existsByPropertyIdAndChecklistId" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM Property_Checklist
            WHERE property_id = #{propertyId}
              AND checklist_id = #{checklistId}
        )
    </select>

    <insert id="insertPropertyChecklist">
        INSERT INTO Property_Checklist (property_id, checklist_id)
        VALUES (#{propertyId}, #{checklistId})
    </insert>

    <select id="findChecklistByIdAndUserId" resultType="org.livin.property.entity.ChecklistVO">
        SELECT * FROM Checklist WHERE checklist_id = #{checklistId} AND user_id = #{userId}
    </select>

    <select id="findItemsByChecklistId" resultType="org.livin.property.entity.ChecklistItemVO">
        SELECT * FROM ChecklistItem WHERE checklist_id = #{checklistId}
    </select>

    <insert id="insertAndGetId" useGeneratedKeys="true" keyProperty="checklistId">
        INSERT INTO Checklist (user_id, title, description, type, created_at, updated_at)
        VALUES (#{userId}, #{title}, #{description}, #{type}, NOW(), NOW())
    </insert>

    <insert id="batchInsertItems" parameterType="java.util.List">
        INSERT INTO ChecklistItem (checklist_id, keyword, is_active, is_checked, type)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.checklistId}, #{item.keyword}, #{item.isActive}, #{item.isChecked}, #{item.type})
        </foreach>
    </insert>

    <select id="findChecklistIdByPropertyAndUser" resultType="long">
        SELECT
            pc.checklist_id
        FROM
            Property_Checklist pc
                JOIN
            Checklist c ON pc.checklist_id = c.checklist_id
        WHERE
            pc.property_id = #{propertyId}
          AND
            c.user_id = #{userId}
            LIMIT 1 -- 한 매물에 한 사용자의 체크리스트는 하나라고 가정
    </select>

    <select id="findChecklistItemsByChecklistIdAndUser" resultType="org.livin.property.dto.ChecklistItemDTO">
        SELECT
            ci.checklistitem_id AS checklistItemId,
            ci.keyword,
            ci.is_active        AS isActive,
            ci.is_checked       AS isChecked,
            ci.type,
            ci.checklist_id     AS checklistId
        FROM
            ChecklistItem ci
                JOIN
            Checklist c ON ci.checklist_id = c.checklist_id
        WHERE
            ci.checklist_id = #{checklistId}
          AND
            c.user_id = #{userId}
        ORDER BY
            ci.checklistitem_id ASC
    </select>

    <update id="updateChecklistItemIsChecked">
        UPDATE ChecklistItem ci
            JOIN Checklist c ON c.checklist_id = ci.checklist_id
            SET
                ci.is_checked = #{isChecked}
        WHERE
            ci.checklistitem_id = #{checklistItemId}
          AND ci.checklist_id = #{checklistId}
          AND c.user_id = #{userId}
    </update>

</mapper>