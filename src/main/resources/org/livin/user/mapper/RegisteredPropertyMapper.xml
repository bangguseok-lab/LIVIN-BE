<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.livin.user.mapper.RegisteredPropertyMapper">

    <select id="selectMyProperties" resultType="org.livin.property.entity.PropertyVO">
        SELECT
            p.property_id,
            p.name,
            p.detail_address,
            p.jeonse_deposit,
            p.monthly_deposit,
            p.monthly_rent,
            p.property_type,
            p.transaction_type,
            p.supply_area_m2,
            p.exclusive_area_m2,
            p.floor,
            p.num_room,
            p.num_bathrooms,
            p.main_direction,
            p.duplex_structure,
            p.move_in_date,
            p.description,
            p.created_at,
            p.updated_at,
            p.sido,
            p.sigungu,
            p.eupmyendong,
            p.property_num,
            p.pet,
            p.loan,
            p.building_id,
            b.total_floors,
            b.road_address,
            CASE WHEN fp.property_id IS NOT NULL THEN TRUE ELSE FALSE END AS is_favorite,
            fp.saved_at,
            ra.is_safe
        FROM
            Property p
                INNER JOIN
            Building b ON p.building_id = b.building_id
                LEFT JOIN
            FavoriteProperty fp ON p.property_id = fp.property_id AND fp.user_id = #{userId}
                LEFT JOIN
            riskAnalysis ra ON p.property_id = ra.property_id
        WHERE
            p.user_id = #{userId}
        ORDER BY p.created_at DESC
    </select>

    <select id="countMyProperties" resultType="long">
        SELECT
            COUNT(*)
        FROM
            Property
        WHERE
            user_id = #{userId}
    </select>

    <delete id="deleteProperty">
        DELETE FROM
            Property
        WHERE
            property_id = #{propertyId} AND user_id = #{userId}
    </delete>

</mapper>